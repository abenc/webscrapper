var fs=require('fs');
var scrap=require('scrap');

exports.postAndScrap = function (req,res){

  var url = req.body.urltoscrap;
  //console.log(url);

      scrap(url,function(err,$){


      var data = $('body').children().first().text();
      //get the model
      var model = $('td[itemprop="model"]').text().trim();

      req.session.json.marque = $('td[itemprop="brand"]').text();
      req.session.json.modele = model;
      req.session.json.anneeModele = getProp("annee",data);
      req.session.json.kilometrage = getProp("km",data);
      req.session.json.carburant = getProp("nrj",data);
      req.session.json.vitesse = getProp("vitesse",data);
      req.session.json.prix = getProp("prix",data);
      //get url image
      req.session.json.urlimg=$('.lbcImages').children().first().attr('content');
      //get the title
      req.session.json.titre=$('#ad_subject').text();

      //create the url for lacentrale's scrapping
      marque = req.session.json.marque.replace(" ","+");
      modele = req.session.json.modele.replace(" ","+");
      anneeModele = req.session.json.anneeModele;

      var filtre = req.session.json.titre.replace(new RegExp('([ ,\,,(),-,.])','g'),' ');
      req.session.json.urlLacentrale="http://www.lacentrale.fr/cote-voitures-"+marque+"-"+modele+"-"+filtre+"-"+anneeModele+"-.html";
      console.log(req.session.json);
      res.redirect('/scraplacentrale');
    });

  }

exports.initScrap=  function (req,res){

    if(typeof(req.session.json)=='undefined'){

      req.session.json={titre:"",marque:"",modele:"",anneeModele:"",kilometrage:"",carburant:"",vitesse:"",prix:"",urlimg:"",urlLacentrale:""};
    }
    res.render('accueil.ejs');

  }
  //functions
  function getProp(prop,chaine){
  var mot = prop+" : ";
  var position_debut = chaine.indexOf(mot);
  var position_fin= chaine.indexOf('",',position_debut);
  var longueur = position_fin-(position_debut+(mot.length));
  return chaine.substr(position_debut+(mot.length)+1,longueur-1);
  }

  function generateJson(fs,json,filename){
    fs.writeFile(filename,JSON.stringify(json,null,8),function(err){
      console.log('json created successfully');
    });
  }
  String.prototype.capitalizeFirstLetter = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
}
