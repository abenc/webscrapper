var fs = require('fs');
var scrap= require('scrap');
var jsonleboncoin;
var jsonresultats;
var jsonlacentrale;

exports.scrapLacentrale = function(req,res){
  scraplvl_un(req,res,scraplvl_deux);
}
exports.scrapLacentralePack = function(req,res){
  var urlcote = decodeURIComponent(req.params.url);
  console.log(urlcote);
  scraplvl_deux(null,urlcote,req,res);
}

var scraplvl_deux = function(err,url,req,res){


    jsonlacentrale={titrehisto:"",urlhisto:"",cotebrute:"",coteaffinee:"",affaire:""}
    scrap(url,function(err,$){
      jsonlacentrale.titrehisto = $('#histo').attr('title');
      jsonlacentrale.urlhisto = "http://www.lacentrale.fr/"+$('#histo').attr('src');
      jsonlacentrale.cotebrute = ($('.tx12 span').text()).replace('â‚¬','').trim();



    scrap(getURLCoteAff($('body').text(),jsonleboncoin.kilometrage,jsonleboncoin.anneeModele,jsonlacentrale),function(err,$,code,html){
        //console.log(urlCoteAffinee);
        jsonlacentrale.coteaffinee = GetCoteAff(html,jsonlacentrale.cotebrute.replace(' ', ''));
        var cote = Number(jsonlacentrale.coteaffinee);
        var prix = Number(jsonleboncoin.prix);
        if( (prix-cote) < 0 ) jsonlacentrale.affaire=true; else jsonlacentrale.affaire=false;
        console.log("affinee:"+jsonlacentrale.coteaffinee);

        res.render('cote_new.ejs',{jsonleboncoin:jsonleboncoin,jsonlacentrale:jsonlacentrale,jsonresultats:jsonresultats});

      });


  });

}
var scraplvl_un = function (req,res,scrapcallback){

  jsonresultats = [];
  jsonleboncoin = req.session.json;
  //console.log(jsonleboncoin);

  scrap(jsonleboncoin.urlLacentrale,function(err,$){

     $('#TabAnnHomeCote tr').each(function(i,row){
      var item ={};
        $(row).find('td').each(function(i,cell){


          if(i==1){
            item['titre']=jsonleboncoin.marque+' '+($(cell).find('a').text()).toLowerCase();
            item['url']=encodeURIComponent('http://www.lacentrale.fr/'+$(cell).find('a').attr('href'));

          }
          if(i==2){item['carburant']=$(cell).text().toLowerCase().sansAccent().trim()}
          if(i==4){item['vitesse']=$(cell).text().toLowerCase().sansAccent().trim();}
          if(i==5){

            if ( item['carburant']==jsonleboncoin.carburant &&  ( (item['vitesse'] == jsonleboncoin.vitesse) || (item['vitesse']=="mecanique" && jsonleboncoin.vitesse=='manuelle') ) ){ //si l'item correspond au critere de leboncoin, ajouter la voiture dans le json lacentrale
              jsonresultats.push(item);
            }
          }
        });//cell

     });//row
     console.log('///////////////////////');
     //console.log(jsonresultats);
     console.log('///////////////////////');
     if(jsonresultats.length ==  0 ){
       res.redirect('/');
     }
    else{
     scrapcallback(null,decodeURIComponent(jsonresultats[0].url),req,res);
      }
     //res.render('selectcar.ejs',{jsonleboncoin:json,jsonresultats:jsonlacentrale});
    });//scrap func

}
String.prototype.sansAccent = function(){
    var accent = [
        /[\300-\306]/g, /[\340-\346]/g, // A, a
        /[\310-\313]/g, /[\350-\353]/g, // E, e
        /[\314-\317]/g, /[\354-\357]/g, // I, i
        /[\322-\330]/g, /[\362-\370]/g, // O, o
        /[\331-\334]/g, /[\371-\374]/g, // U, u
        /[\321]/g, /[\361]/g, // N, n
        /[\307]/g, /[\347]/g, // C, c
    ];
    var noaccent = ['A','a','E','e','I','i','O','o','U','u','N','n','C','c'];

    var str = this;
    for(var i = 0; i < accent.length; i++){
        str = str.replace(accent[i], noaccent[i]);
    }

    return str;
}

var getURLCoteAff = function(chaine,km,annee,jsonlacentrale){

  var motdebut = 'var pq = new PersoQuot';
  var position_debut = chaine.indexOf(motdebut) + motdebut.length+1;
  var position_fin=chaine.indexOf(");",position_debut);
  var longueur = position_fin-(position_debut);
  var exp=(chaine.substr(position_debut,longueur)).split(',');
  var a,b,c,d,e,f,g;
  a=exp[1].trim();
  b=annee;
  c=km
  d=exp[5].replace(new RegExp('\'','g'),'').trim();
  e=exp[0];
  f=exp[3].trim();
  g=exp[4].trim();
   var urlCoteAffinee ="http://www.lacentrale.fr/ze_proxy.php?ws=get_cote_lc&user=js&password=none&out=js&type=perso&dtid="+a+"&millesime="+b+"&km="+c+"&firsthand=2&fdt="+b+"-01&categorie="+d+"&cote="+e+"&energy="+f+"&power="+g;
   return urlCoteAffinee;
}

function GetCoteAff(chaine,cotebrute){

  return Number(cotebrute)+parseParam("appr_km']='",chaine)+parseParam("appr_mec']='",chaine);
}

function parseParam(cle,chaine){
  //"appr_km']='"
  //"appr_mec']='"
  var pos_deb= chaine.indexOf(cle)+cle.length;
  var pos_fin = chaine.indexOf("'",pos_deb);
  var long = pos_fin-pos_deb;
  return Number(chaine.substr((pos_deb),long));
}
